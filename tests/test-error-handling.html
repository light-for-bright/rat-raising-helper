<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест обработки ошибок</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container mt-4">
        <h1>Тест улучшенной обработки ошибок</h1>
        
        <!-- Тест уведомлений -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="h6 mb-0">Тест уведомлений</h5>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-success" onclick="testSuccessNotification()">Успех</button>
                    <button type="button" class="btn btn-info" onclick="testInfoNotification()">Информация</button>
                    <button type="button" class="btn btn-warning" onclick="testWarningNotification()">Предупреждение</button>
                    <button type="button" class="btn btn-danger" onclick="testErrorNotification()">Ошибка</button>
                </div>
            </div>
        </div>
        
        <!-- Тест обработки ошибок -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="h6 mb-0">Тест обработки ошибок</h5>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" onclick="testValidationError()">Ошибка валидации</button>
                    <button type="button" class="btn btn-secondary" onclick="testCalculationError()">Ошибка расчета</button>
                    <button type="button" class="btn btn-dark" onclick="testStorageError()">Ошибка сохранения</button>
                    <button type="button" class="btn btn-light" onclick="testUIError()">Ошибка UI</button>
                </div>
            </div>
        </div>
        
        <!-- Тест LocalStorage -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="h6 mb-0">Тест LocalStorage</h5>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="testLocalStorageAvailable()">Проверить доступность</button>
                    <button type="button" class="btn btn-outline-success" onclick="testSaveGame()">Сохранить игру</button>
                    <button type="button" class="btn btn-outline-info" onclick="testLoadGame()">Загрузить игру</button>
                    <button type="button" class="btn btn-outline-warning" onclick="testCorruptedData()">Тест поврежденных данных</button>
                </div>
            </div>
        </div>
        
        <!-- Тест валидации данных -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="h6 mb-0">Тест валидации данных</h5>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-danger" onclick="testInvalidGameState()">Некорректное состояние</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="testMissingFields()">Отсутствующие поля</button>
                    <button type="button" class="btn btn-outline-dark" onclick="testInvalidTypes()">Неправильные типы</button>
                    <button type="button" class="btn btn-outline-light" onclick="testValidState()">Корректное состояние</button>
                </div>
            </div>
        </div>
        
        <!-- Консоль отладки -->
        <div class="mt-4">
            <h3>Консоль отладки</h3>
            <div id="console" class="bg-dark text-light p-3" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
            </div>
        </div>
    </div>

    <!-- Подключение JavaScript файлов -->
    <script src="js/game-data.js?v=7"></script>
    <script src="js/calculations.js?v=2"></script>
    <script src="js/app.js?v=20"></script>
    
    <script>
        // Переопределяем функцию log для отображения в консоли
        function log(message, data = null) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.innerHTML += logMessage + '<br>';
            if (data) {
                console.innerHTML += JSON.stringify(data, null, 2) + '<br>';
            }
            console.scrollTop = console.scrollHeight;
        }
        
        // Тест уведомлений
        function testSuccessNotification() {
            showSuccessNotification('Операция выполнена успешно!');
            addToConsole('Показано уведомление об успехе');
        }
        
        function testInfoNotification() {
            showInfoNotification('Это информационное сообщение');
            addToConsole('Показано информационное уведомление');
        }
        
        function testWarningNotification() {
            showWarningNotification('Внимание! Проверьте введенные данные');
            addToConsole('Показано предупреждение');
        }
        
        function testErrorNotification() {
            showUserNotification('Произошла критическая ошибка!', 'danger');
            addToConsole('Показано уведомление об ошибке');
        }
        
        // Тест обработки ошибок
        function testValidationError() {
            try {
                throw new Error('Ошибка валидации данных');
            } catch (error) {
                handleError(error, 'Валидация ввода', ERROR_TYPES.VALIDATION);
            }
            addToConsole('Протестирована ошибка валидации');
        }
        
        function testCalculationError() {
            try {
                throw new Error('Ошибка при расчете');
            } catch (error) {
                handleError(error, 'Расчет доходов', ERROR_TYPES.CALCULATION);
            }
            addToConsole('Протестирована ошибка расчета');
        }
        
        function testStorageError() {
            try {
                throw new Error('Ошибка LocalStorage');
            } catch (error) {
                handleError(error, 'Сохранение игры', ERROR_TYPES.STORAGE);
            }
            addToConsole('Протестирована ошибка сохранения');
        }
        
        function testUIError() {
            try {
                throw new Error('Ошибка интерфейса');
            } catch (error) {
                handleError(error, 'Обновление интерфейса', ERROR_TYPES.UI);
            }
            addToConsole('Протестирована ошибка UI');
        }
        
        // Тест LocalStorage
        function testLocalStorageAvailable() {
            const isAvailable = isLocalStorageAvailable();
            addToConsole(`LocalStorage доступен: ${isAvailable ? 'ДА' : 'НЕТ'}`);
            if (isAvailable) {
                showSuccessNotification('LocalStorage доступен');
            } else {
                showWarningNotification('LocalStorage недоступен');
            }
        }
        
        function testSaveGame() {
            // Устанавливаем тестовые данные
            gameState.profession = 'Тестер';
            gameState.income.salary = 50000;
            saveGame();
            addToConsole('Попытка сохранения игры');
        }
        
        function testLoadGame() {
            const loaded = loadGame();
            addToConsole(`Игра загружена: ${loaded ? 'ДА' : 'НЕТ'}`);
        }
        
        function testCorruptedData() {
            // Сохраняем поврежденные данные
            localStorage.setItem('rat_race_game', 'invalid json data');
            const loaded = loadGame();
            addToConsole('Попытка загрузки поврежденных данных');
        }
        
        // Тест валидации данных
        function testInvalidGameState() {
            const invalidState = null;
            const isValid = validateGameState(invalidState);
            addToConsole(`Валидация null: ${isValid ? 'ПРОШЛА' : 'НЕ ПРОШЛА'}`);
        }
        
        function testMissingFields() {
            const incompleteState = { profession: 'Тестер' };
            const isValid = validateGameState(incompleteState);
            addToConsole(`Валидация неполных данных: ${isValid ? 'ПРОШЛА' : 'НЕ ПРОШЛА'}`);
        }
        
        function testInvalidTypes() {
            const invalidTypesState = {
                profession: 'Тестер',
                dream: 'Мечта',
                auditor: 'Аудитор',
                income: { salary: 'не число' },
                expenses: {},
                assets: {},
                liabilities: {}
            };
            const isValid = validateGameState(invalidTypesState);
            addToConsole(`Валидация неправильных типов: ${isValid ? 'ПРОШЛА' : 'НЕ ПРОШЛА'}`);
        }
        
        function testValidState() {
            const validState = {
                profession: 'Тестер',
                dream: 'Мечта',
                auditor: 'Аудитор',
                income: { salary: 50000, realEstateBusiness: [] },
                expenses: { taxes: 10000, houseMortgage: 0, educationLoan: 0, carLoan: 0, creditCards: 0, otherExpenses: 0, bankLoan: 0, childrenExpenses: 0, childrenCount: 0 },
                assets: { savings: 100000, preciousMetals: 0, stocks: [], realEstateBusiness: [] },
                liabilities: { houseMortgage: 0, educationLoan: 0, carLoan: 0, creditCards: 0, bankLoan: 0, realEstateBusiness: [] },
                cashFlow: { initialBalance: 0, transactions: [] },
                stage2: { passiveIncomeAtTransition: 0, targetAmount: 0, businesses: [] },
                currentStage: 1,
                stage2Unlocked: false
            };
            const isValid = validateGameState(validState);
            addToConsole(`Валидация корректных данных: ${isValid ? 'ПРОШЛА' : 'НЕ ПРОШЛА'}`);
            if (isValid) {
                showSuccessNotification('Данные валидны');
            }
        }
        
        function addToConsole(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            console.innerHTML += `[${timestamp}] ${message}<br>`;
            console.scrollTop = console.scrollHeight;
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            addToConsole('Страница загружена');
            addToConsole('Система обработки ошибок готова к тестированию');
        });
    </script>
</body>
</html>
